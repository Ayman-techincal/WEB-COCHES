<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Iniciar Sesión - Premium Cars</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
    <style>
      body { background: linear-gradient(135deg, #1a1a2e, #16213e); color: #fff; }
      .navbar { background: linear-gradient(135deg, #000, #1a1a1a, #2c2c2c); border-bottom: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(8px); }
      .navbar-brand { font-family: 'Playfair Display', serif; font-weight: 900; letter-spacing: 1px; font-size: 1.6rem; position: relative; top: -6px; color: #c0c0c0 !important; }
      .card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.04); }
      .form-label { color: #e6eef8; }
      /* Ensure headings and button text are visible on the dark card */
      .card h3, .card h4 { color: #fff !important; }
      .btn-outline-primary.text-white, .btn-outline-primary.text-white:hover { color: #fff !important; }
      .btn-outline-primary.text-white:hover { background-color: rgba(255,255,255,0.04); }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container">
        <a class="navbar-brand" href="index.html">Premium Cars</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a class="nav-link" href="index.html">Inicio</a></li>
            <li class="nav-item"><a class="nav-link" href="catalogo.html">Catálogo</a></li>
            <li class="nav-item"><a class="nav-link active" href="login.html">Iniciar Sesion</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container my-5">
      <div class="row justify-content-center">
        <div class="col-12 col-md-8 col-lg-6">
          <div class="card shadow-sm p-4">
            <h3 class="mb-4 text-center text-white">¿Qué deseas hacer?</h3>
            <div class="d-grid gap-3 mb-4">
              <button type="button" class="btn btn-primary btn-lg text-white" onclick="showForm('login')">Iniciar Sesión</button>
              <button type="button" class="btn btn-outline-primary btn-lg text-white" onclick="showForm('register')">Crear Cuenta Nueva</button>
            </div>

            <!-- Alert placeholder para mensajes inline -->
            <div id="registerAlert" class="mb-3" aria-live="polite"></div>

            <!-- Formulario de Login -->
            <form id="loginForm" onsubmit="return handleLogin(event)" style="display: none;">
              <h4 class="mb-3">Iniciar Sesión</h4>
              <div class="row">
                <div class="col-12 mb-3">
                  <label for="username" class="form-label">Nombre de Usuario</label>
                  <input type="text" class="form-control" id="username" name="username" placeholder="Introduce tu nombre de usuario" required>
                </div>
              </div>

              <div class="row">
                <div class="col-12 mb-3">
                  <label for="pwd" class="form-label">Contraseña</label>
                  <div class="input-group">
                    <input type="password" class="form-control" id="pwd" name="pswd" placeholder="Introduce contraseña" required>
                    <button class="btn btn-outline-secondary" type="button" id="togglePwd">Mostrar</button>
                  </div>
                </div>
              </div>

              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" name="remember" id="remember">
                <label class="form-check-label" for="remember">Recuérdame</label>
              </div>

              <div class="d-grid">
                <button type="submit" class="btn btn-primary text-white">Iniciar Sesión</button>
              </div>
            </form>

            <!-- Formulario de Registro -->
            <form id="registerForm" onsubmit="return handleRegister(event)" style="display: none;">
              <h4 class="mb-3">Crear Cuenta Nueva</h4>
              <div class="row">
                <div class="col-12 mb-3">
                  <label for="reg-username" class="form-label">Nombre de Usuario</label>
                  <input type="text" class="form-control" id="reg-username" name="username" placeholder="Elige un nombre de usuario" required>
                </div>
              </div>

              <div class="row">
                <div class="col-12 mb-3">
                  <label for="reg-email" class="form-label">Correo Electrónico</label>
                  <input type="email" class="form-control" id="reg-email" name="email" placeholder="Introduce tu correo electrónico" required>
                </div>
              </div>

              <div class="row">
                <div class="col-12 mb-3">
                  <label for="reg-pwd" class="form-label">Contraseña</label>
                  <div class="input-group">
                    <input type="password" class="form-control" id="reg-pwd" name="pswd" placeholder="Elige una contraseña" required>
                    <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('reg-pwd', this)">Mostrar</button>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-12 mb-3">
                  <label for="reg-pwd-confirm" class="form-label">Confirmar Contraseña</label>
                  <div class="input-group">
                    <input type="password" class="form-control" id="reg-pwd-confirm" name="pswd-confirm" placeholder="Repite la contraseña" required>
                    <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('reg-pwd-confirm', this)">Mostrar</button>
                  </div>
                </div>
              </div>

              <div class="d-grid">
                <button type="submit" class="btn btn-primary text-white">Crear Cuenta</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Mostrar el formulario seleccionado. Por defecto mostramos registro.
      function showForm(formType) {
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('registerForm').style.display = 'none';

        if (formType === 'login') {
          document.getElementById('loginForm').style.display = 'block';
        } else {
          document.getElementById('registerForm').style.display = 'block';
        }
      }

      // Función para alternar la visibilidad de la contraseña
      function togglePassword(inputId, button) {
        const input = document.getElementById(inputId);
        if (input.type === 'password') {
          input.type = 'text';
          button.textContent = 'Ocultar';
        } else {
          input.type = 'password';
          button.textContent = 'Mostrar';
        }
      }

      // Manejar el botón de mostrar/ocultar contraseña original
      document.getElementById('togglePwd').addEventListener('click', function() {
        togglePassword('pwd', this);
      });

      // Manejar inicio de sesión: validar contra cuentas guardadas
      function handleLogin(event) {
        event.preventDefault();
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('pwd').value;

        const users = JSON.parse(localStorage.getItem('users') || '[]');
        if (!users.length) {
          alert('No existen cuentas. Por favor crea una cuenta primero.');
          showForm('register');
          return false;
        }

        const found = users.find(u => u.username === username && u.password === password);
        if (found) {
          localStorage.setItem('currentUser', found.username);
          // opcional: guardar email
          localStorage.setItem('currentUserEmail', found.email || '');
          window.location.href = 'index.html';
          return false;
        }

        alert('Usuario o contraseña incorrectos.');
        return false;
      }

      // Manejar registro: crear cuenta y enviar los datos a Formspree para notificar al admin
      async function handleRegister(event) {
        event.preventDefault();
        const username = document.getElementById('reg-username').value.trim();
        const email = document.getElementById('reg-email').value.trim();
        const password = document.getElementById('reg-pwd').value;
        const confirmPassword = document.getElementById('reg-pwd-confirm').value;

        if (!username || !email || !password) {
          alert('Rellena todos los campos.');
          return false;
        }

        if (password !== confirmPassword) {
          alert('Las contraseñas no coinciden');
          return false;
        }

        // cargar usuarios existentes
        const users = JSON.parse(localStorage.getItem('users') || '[]');
        // comprobar si username o email ya existe
        if (users.some(u => u.username === username)) {
          alert('El nombre de usuario ya existe. Elige otro.');
          return false;
        }
        if (users.some(u => u.email === email)) {
          alert('Ya existe una cuenta con ese correo.');
          return false;
        }

        // guardar nueva cuenta (nota: contraseña en texto plano — para demo local)
        users.push({ username, email, password });
        localStorage.setItem('users', JSON.stringify(users));
        // marcar como logueado
        localStorage.setItem('currentUser', username);
        localStorage.setItem('currentUserEmail', email);

        // Enviar notificación por email a través de Formspree
        const endpoint = 'https://formspree.io/f/mldoyozv';
        // preparar datos para Formspree; incluimos _replyto para que puedas responder al usuario
        const params = new URLSearchParams();
        params.append('name', username);
        params.append('email', email);
        params.append('_replyto', email);
        params.append('_subject', 'Nuevo registro - Premium Cars');
        params.append('message', `Nuevo usuario: ${username} (${email})`);

        const alertEl = document.getElementById('registerAlert');
        let notifyStatus = 'failed';
        let responseStatus = null;

        try {
          const btn = event.target.querySelector('button[type="submit"]');
          if (btn) { btn.disabled = true; btn.textContent = 'Enviando...'; }

          const res = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params.toString()
          });

          responseStatus = res.status;
          if (res.ok) {
            notifyStatus = 'sent';
            alertEl.innerHTML = '<div class="alert alert-success" role="alert">Registro creado correctamente. Te hemos enviado una notificación (revisa tu correo).</div>';
          } else {
            alertEl.innerHTML = '<div class="alert alert-warning" role="alert">Registro creado, pero no se pudo enviar la notificación por email. (status: ' + res.status + ')</div>';
          }

          if (btn) { btn.disabled = false; btn.textContent = 'Crear Cuenta'; }
        } catch (err) {
          console.error('Error enviando a Formspree:', err);
          alertEl.innerHTML = '<div class="alert alert-warning" role="alert">Registro creado, pero no se pudo enviar la notificación por email.</div>';
          if (event && event.target) {
            const btn = event.target.querySelector('button[type="submit"]');
            if (btn) { btn.disabled = false; btn.textContent = 'Crear Cuenta'; }
          }
        }

        // Guardar un registro local de la notificación enviada (para auditoría local)
        try {
          const sent = JSON.parse(localStorage.getItem('sentNotifications') || '[]');
          sent.push({ username, email, timestamp: new Date().toISOString(), status: notifyStatus, responseStatus });
          localStorage.setItem('sentNotifications', JSON.stringify(sent));
        } catch (e) { console.warn('No se pudo guardar el log de notificación:', e); }

        // Redirigir tras breve pausa para que el usuario vea el mensaje
        setTimeout(() => { window.location.href = 'index.html'; }, 1200);
        return false;
      }

      // Mostrar registro por defecto al cargar la página
      document.addEventListener('DOMContentLoaded', function(){
        showForm('register');
      });

    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  </body>
</html>